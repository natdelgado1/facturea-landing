---
import Badge from "../UI/Badge.astro";
import { HowItWorks } from "../../../data/HowItWorks.js";
import TitlePrimary from "../UI/TitlePrimary.astro";
---

<!-- ¿Cómo funciona? - Estilo moderno inspirado en HeroVersion2 -->
<section class="overflow-hidden relative py-20 bg-gradient-to-b from-gray-50 to-white sm:py-24 md:py-32" id="como-funciona">
    <!-- Elementos decorativos flotantes - Responsive -->
    <div class="overflow-hidden absolute inset-0 pointer-events-none">
        <div class="absolute left-6 top-24 w-20 h-20 bg-gradient-to-br rounded-full opacity-30 blur-xl sm:top-28 md:top-32 sm:left-12 md:left-16 sm:w-24 sm:h-24 md:w-28 md:h-28 from-primary/20 to-accent/10 sm:blur-2xl sm:opacity-40"></div>
        <div class="absolute right-4 top-48 w-24 h-24 bg-gradient-to-br rounded-full opacity-40 blur-2xl sm:top-56 md:top-60 sm:right-8 md:right-12 sm:w-30 sm:h-30 md:w-36 md:h-36 from-secondary/25 to-primary/15 sm:blur-3xl sm:opacity-50"></div>
        <div class="absolute bottom-32 left-1/3 w-20 h-20 bg-gradient-to-br rounded-full opacity-25 blur-xl sm:bottom-36 md:bottom-40 sm:w-28 sm:h-28 md:w-32 md:h-32 from-accent/20 to-secondary/10 sm:blur-2xl sm:opacity-35"></div>
        <div class="absolute bottom-16 right-1/4 w-16 h-16 bg-gradient-to-br rounded-full opacity-30 blur-lg sm:bottom-18 md:bottom-20 sm:w-20 sm:h-20 md:w-24 md:h-24 from-primary/30 to-accent/20 sm:blur-xl sm:opacity-40"></div>
    </div>
    
    <div class="container relative z-10 px-4 mx-auto sm:px-6">
        <div class="mx-auto max-w-6xl text-center">
            
            <!-- Badge superior -->
            <div class="gsap-badge">
                <Badge text={HowItWorks.badge} />
            </div>

            <!-- Título principal con gradiente - Responsive -->
            <TitlePrimary text={HowItWorks.title} boldText={HowItWorks.title2} />
            
            <!-- Subtítulo - Responsive -->
            <p class="px-4 mx-auto mb-12 max-w-4xl text-lg leading-relaxed text-gray-600 gsap-subtitle sm:text-xl md:text-2xl sm:mb-6 sm:px-0">
                {HowItWorks.description} <span class="font-semibold text-secondary">{HowItWorks.tab1}</span> 
                e <span class="font-semibold text-primary">{HowItWorks.inverseTab1}</span>
            </p>

            <!-- Tabs modernos - Responsive -->
            <div class="flex justify-center mb-12 gsap-tabs sm:mb-6">
                <div class="p-1 w-full max-w-lg bg-white rounded-xl border border-gray-200 shadow-xl sm:rounded-2xl sm:p-0 sm:max-w-none sm:w-auto">
                    <button id="tab-facturador-btn" class="px-4 py-3 w-full text-base font-bold rounded-lg transition-all duration-300 sm:w-auto sm:px-8 sm:py-4 sm:rounded-xl sm:text-lg tab-btn active-tab">
                        <span class="sm:hidden">{HowItWorks.tab1}</span>
                        <span class="hidden sm:inline">{HowItWorks.tab1}</span>
                    </button>
                    <button id="tab-inversor-btn" class="px-4 py-3 mt-1 w-full text-base font-bold rounded-lg transition-all duration-300 sm:w-auto sm:px-8 sm:py-4 sm:rounded-xl sm:text-lg tab-btn inactive-tab sm:mt-0">
                        <span class="sm:hidden">{HowItWorks.tab2}</span>
                        <span class="hidden sm:inline">{HowItWorks.tab2}</span>
                    </button>
                </div>
            </div>

            <!-- Contenido Facturador -->
            <div id="content-facturador" class="tab-content-modern">
                <div class="grid gap-6 mx-auto max-w-5xl h-full sm:grid-cols-2 lg:grid-cols-3 sm:gap-8">
                    {HowItWorks.tab1Body.map((item, index) => (
                        <div class="h-full group gsap-card" data-index={index}>
                            <div class="card-wrapper">
                                <div class="card-hover-bg"></div>
                                <div class="card-content">
                                    <!-- Número con gradiente -->
                                    <div class="icon-container group-hover:scale-110">
                                        <span class="text-2xl font-bold text-white sm:text-3xl very-short:text-xl">{index + 1}</span>
                                    </div>
                                    
                                    <h3 class="mb-4 text-xl font-bold text-gray-900 sm:text-2xl sm:mb-6">{item.title}</h3>
                                    <p class="text-base leading-relaxed text-gray-600 sm:text-lg">{item.description}</p>
                                    
                                    <!-- Badge + icono -->
                                    <div class="inline-flex items-center px-3 py-1.5 mt-4 text-xs font-semibold text-green-700 bg-green-100 rounded-full sm:mt-6 sm:px-4 sm:py-2 sm:text-sm badge-morphing">
                                        <div class="mr-2 w-4 h-4 badge-icon-container">
                                            <Fragment set:html={item.icon} />
                                        </div>
                                        {item.badge}
                                    </div>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            </div>

            <!-- Contenido Inversor -->
            <div id="content-inversor" class="hidden tab-content-modern">
                <div class="grid gap-6 mx-auto max-w-5xl sm:grid-cols-2 lg:grid-cols-3 sm:gap-8">
                    {HowItWorks.tab2Body.map((item, index) => (
                        <div class="h-full group gsap-card" data-index={index}>
                            <div class="card-wrapper">
                                <div class="card-hover-bg"></div>
                                <div class="card-content">
                                    <!-- Número con gradiente -->
                                    <div class="icon-container group-hover:scale-110">
                                        <span class="text-2xl font-bold text-white sm:text-3xl very-short:text-xl">{index + 1}</span>
                                    </div>
                                    
                                    <h3 class="mb-4 text-xl font-bold text-gray-900 sm:text-2xl sm:mb-6">{item.title}</h3>
                                    <p class="text-base leading-relaxed text-gray-600 sm:text-lg">{item.description}</p>
                                    
                                    <!-- Badge + icono -->
                                    <div class="inline-flex items-center px-3 py-1.5 mt-4 text-xs font-semibold text-green-700 bg-green-100 rounded-full sm:mt-6 sm:px-4 sm:py-2 sm:text-sm badge-morphing">
                                        <div class="mr-2 w-4 h-4 badge-icon-container">
                                            <Fragment set:html={item.icon} />
                                        </div>
                                        {item.badge}
                                    </div>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        </div>
    </div>
</section>

<style>
    /* Elementos decorativos flotantes */
    .floating-decorations {
        @apply overflow-hidden absolute inset-0 pointer-events-none;
    }

    .floating-element {
        @apply absolute rounded-full blur-lg;
        will-change: transform;
    }

    .floating-element--1 {
        @apply left-4 top-10 w-20 h-20 opacity-30 bg-gradient-to-br from-primary/20 to-accent/10 sm:top-16 sm:left-6 sm:w-28 sm:h-28 sm:blur-xl sm:opacity-40 md:top-20 md:left-10 md:w-32 md:h-32;
    }

    .floating-element--2 {
        @apply right-8 top-32 w-16 h-16 opacity-40 blur-xl bg-gradient-to-br from-secondary/30 to-primary/20 sm:top-36 sm:right-12 sm:w-20 sm:h-20 sm:blur-2xl sm:opacity-50 md:top-40 md:right-20 md:w-24 md:h-24;
    }

    .floating-element--3 {
        @apply bottom-24 left-1/4 w-24 h-24 opacity-20 blur-2xl bg-gradient-to-br from-accent/15 to-secondary/10 sm:bottom-28 sm:w-32 sm:h-32 sm:blur-3xl sm:opacity-30 md:bottom-32 md:w-40 md:h-40;
    }

    .floating-element--4 {
        @apply bottom-16 right-1/3 w-20 h-20 opacity-25 blur-xl bg-gradient-to-br from-primary/25 to-accent/15 sm:bottom-20 sm:w-24 sm:h-24 sm:blur-2xl sm:opacity-35 md:bottom-24 md:w-28 md:h-28;
    }

    /* Cards optimizadas con GPU acceleration */
    .card-wrapper {
        @apply relative p-6 h-full bg-gradient-to-br from-white to-gray-50 rounded-2xl border border-gray-200 transition-all duration-300 sm:rounded-3xl sm:p-8;
        transform: translate3d(0, 0, 0); /* GPU acceleration */
        will-change: transform; /* Optimización para animaciones */
        /* Sombra sutil por defecto */
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        overflow: hidden; /* Mantener overflow hidden para contenido */
    }

    .card-wrapper:hover {
        @apply shadow-2xl;
        transform: translate3d(0, -4px, 0); /* Solo elevación, sin scale */
        /* El borde se mantiene igual, solo cambia la sombra y el fondo */
    }

    .card-hover-bg {
        @apply absolute inset-0 bg-gradient-to-br opacity-0 transition-opacity duration-500 from-primary/5 to-accent/5 rounded-2xl sm:rounded-3xl;
        will-change: opacity; /* Optimización para transiciones */
        z-index: 1;
    }

    .group:hover .card-hover-bg {
        @apply opacity-100;
    }

    .card-content {
        @apply relative z-10;
        transform: translate3d(0, 0, 0); /* GPU acceleration */
    }

    .icon-container {
        @apply flex justify-center items-center mb-4 w-16 h-16 very-short:w-12 very-short:h-12 very-short:mb-2 bg-gradient-to-br rounded-xl transition-transform duration-300 from-primary to-secondary sm:w-20 sm:h-20 sm:rounded-2xl sm:mb-6;
        transform: translate3d(0, 0, 0); /* GPU acceleration */
        will-change: transform; /* Optimización para hover */
    }

    /* Tabs */
    .active-tab {
        @apply bg-gradient-to-r from-primary to-secondary text-white shadow-lg scale-105;
    }
    
    .inactive-tab {
        @apply text-gray-600 hover:text-gray-900 hover:bg-gray-50;
    }
    
    .tab-content-modern {
        @apply transition-all duration-500 ease-in-out;

    }
    
    /* Estilos para morphing en badges */
    .badge-morphing {
        transition: all 0.3s ease;
    }
    
    .badge-morphing:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .badge-icon-container {
        transition: all 0.2s ease;
    }
    
    .badge-icon {
        transition: all 0.4s ease;
    }
    
    .morph-path-clock-normal,
    .morph-path-clock-active,
    .morph-path-computer,
    .morph-path-cloud,
    .morph-path-calendar,
    .morph-path-money,
    .morph-path-check,
    .morph-path-arrow,
    .morph-path-shield,
    .morph-path-shield-check,
    .morph-path-chart,
    .morph-path-roi-money {
        transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        transform-origin: center;
    }
    
    /* Efectos de hover en badges */
    .badge-morphing:hover .badge-icon-container {
        transform: scale(1.2);
    }
    
    .badge-morphing:hover .badge-icon {
        filter: drop-shadow(0 0 4px currentColor);
    }
    
    /* Animación de entrada */
    .badge-morphing {
        animation: badgeEntrance 0.6s ease-out;
    }
    
    @keyframes badgeEntrance {
        from {
            opacity: 0;
            transform: scale(0.8) translateY(10px);
        }
        to {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
    }

    /* Reducir motion para accesibilidad */
    @media (prefers-reduced-motion: reduce) {
        * {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
        }
    }
</style>

<!-- ✅ Script de tabs - Carga inmediata (crítico para funcionalidad) -->
<script src="/src/scripts/how-it-works-tabs.js" defer></script>

<!-- ✅ Script de animaciones - Lazy loading cuando la sección es visible -->
<script is:inline>
  (function() {
    'use strict';
    
    // Cargar animaciones solo cuando la sección sea visible
    function loadAnimationsWhenVisible() {
      const section = document.getElementById('como-funciona');
      if (!section) {
        // Reintentar si la sección no existe aún
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', loadAnimationsWhenVisible);
        } else {
          setTimeout(loadAnimationsWhenVisible, 100);
        }
        return;
      }

      // Usar IntersectionObserver para lazy loading
      if ('IntersectionObserver' in window) {
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              // Cargar script de animaciones cuando la sección es visible
              const script = document.createElement('script');
              script.src = '/src/scripts/how-it-works-animations.js';
              script.defer = true;
              script.async = true;
              document.head.appendChild(script);
              
              // Desconectar observer después de cargar
              observer.disconnect();
            }
          });
        }, {
          rootMargin: '200px' // Cargar 200px antes de que sea visible
        });
        
        observer.observe(section);
      } else {
        // Fallback para navegadores sin IntersectionObserver
        // Cargar después de un delay
        setTimeout(() => {
          const script = document.createElement('script');
          script.src = '/src/scripts/how-it-works-animations.js';
          script.defer = true;
          script.async = true;
          document.head.appendChild(script);
        }, 2000);
      }
    }

    // Inicializar cuando el DOM esté listo
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadAnimationsWhenVisible);
    } else {
      loadAnimationsWhenVisible();
    }

    // Para navegación SPA de Astro
    document.addEventListener('astro:page-load', loadAnimationsWhenVisible);
  })();
</script> 